<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos de Formularios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h2 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .delete-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background-color: darkred;
        }
        .buttons {
            text-align: center;
            margin-top: 20px;
        }
        .buttons button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .export-btn {
            background-color: blue;
            color: white;
        }
        .filter-btn {
            background-color: orange;
            color: white;
        }
    </style>
</head>
<body>

    <h2>Lista de Formularios Guardados</h2>

    <label for="filtro-fecha">Filtrar por Fecha:</label>
    <input type="date" id="filtro-fecha">
    <button class="filter-btn" onclick="filtrarPorFecha()">Filtrar</button>

    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Barrio/Rama</th>
                <th>Miembro de Presidencia</th>
                <th>Jóvenes Asistieron</th>
                <th>Jóvenes No Asistieron</th>
                <th>Oración de Inicio</th>
                <th>Oración de Fin</th>
                <th>Lema</th>
                <th>Guiador de Clase</th>
                <th>Observaciones</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="cuerpo-tabla">
            <!-- Aquí se llenarán los datos dinámicamente -->
        </tbody>
    </table>

    <div class="buttons">
        <button class="export-btn" onclick="exportarExcel()">Exportar a Excel</button>
        <button onclick="window.location.href='jovenes.html'">Regresar</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", cargarFormularios);

        function cargarFormularios() {
            let formularios = JSON.parse(localStorage.getItem("formularios")) || [];
            mostrarEnTabla(formularios);
        }

        function mostrarEnTabla(datos) {
            const tabla = document.getElementById("cuerpo-tabla");
            tabla.innerHTML = ""; // Limpiar la tabla antes de agregar nuevos datos

            if (datos.length === 0) {
                tabla.innerHTML = `<tr><td colspan="11" style="text-align:center;">No hay formularios disponibles</td></tr>`;
                return;
            }

            const filas = datos.map((formulario, index) => `
                <tr>
                    <td>${formulario["Fecha"] || "No especificado"}</td>
                    <td>${formulario["Barrio/Rama"] || "No especificado"}</td>
                    <td>${formulario["Miembro de Presidencia"] || "No especificado"}</td>
                    <td>${formulario["Jóvenes Asistieron"] || "No especificado"}</td>
                    <td>${formulario["Jóvenes No Asistieron"] || "No especificado"}</td>
                    <td>${formulario["Oración de Inicio"] || "No especificado"}</td>
                    <td>${formulario["Oración de Fin"] || "No especificado"}</td>
                    <td>${formulario["Lema"] || "No especificado"}</td>
                    <td>${formulario["Guiador de Clase"] || "No especificado"}</td>
                    <td>${formulario["Observaciones"] || "No especificado"}</td>
                    <td><button class="delete-btn" onclick="eliminarFormulario(${index})">Eliminar</button></td>
                </tr>
            `).join("");

            tabla.innerHTML = filas;
        }

        function filtrarPorFecha() {
            let fechaFiltro = document.getElementById("filtro-fecha").value;
            let formularios = JSON.parse(localStorage.getItem("formularios")) || [];

            if (!fechaFiltro) {
                alert("Por favor, selecciona una fecha para filtrar.");
                return;
            }

            let filtrados = formularios.filter(form => form["Fecha"] === fechaFiltro);

            if (filtrados.length === 0) {
                alert("No hay formularios registrados para esta fecha.");
            }

            mostrarEnTabla(filtrados);
        }

        function eliminarFormulario(index) {
            let formularios = JSON.parse(localStorage.getItem("formularios")) || [];

            if (index < 0 || index >= formularios.length) {
                alert("Error: No se puede eliminar este formulario.");
                return;
            }

            if (confirm("¿Seguro que quieres eliminar este formulario?")) {
                formularios.splice(index, 1);
                localStorage.setItem("formularios", JSON.stringify(formularios));
                cargarFormularios();
            }
        }

        function exportarExcel() {
            let formularios = JSON.parse(localStorage.getItem("formularios")) || [];

            if (formularios.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }

            // Crear una hoja de cálculo con SheetJS
            const ws = XLSX.utils.json_to_sheet(formularios);

            // Crear un libro de trabajo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Registros");

            // Obtener la fecha actual para el nombre del archivo
            const fechaDescarga = new Date().toISOString().slice(0, 10);
            const nombreArchivo = `Datos_Formularios_${fechaDescarga}.xlsx`;

            // Guardar el archivo
            XLSX.writeFile(wb, nombreArchivo);
        }
    </script>

</body>
</html>
